---
title: "McCool_Snake_Project"
author: "Owen McCool, Therese Lamperty"
date: "2024-09-04"
output: word_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
  
```{r package read in}
library(vegan)
library(stringr)
library(ggplot2)
library(tidyverse)
```


# Project Overview

Study Site: Research was split between two different zones within the greater Yasuni Biosphere Reserve. Tiputini Biodiversity Station (TBS) served as the faunally intact site, whereas Yasuni Research Station (YRS) served as the defaunated site. Both sites are situated along the Tiputini River within the province of Orellana, Ecuador. TBS, approximately 45 km east of YRS, is only accessible by boat. YRS is along the Maxus Oil Road, and is less integrated into the Amazonian ecosystem. Additionally, unsustainable hunting activities by the indigenous communities have been prominent in the surrounding region at YRS for multiple decades, as noted from 2014. This is thought to be the root cause of defaunation in this zone. 

	I transferred between the two research stations every two weeks, starting my first rotation at TBS on June 10. Time at each station was spent working on 3 separate projects: my herpetofauna surveys, frugivory surveys, and an overarching seed enemy and dispersal project. 

	The rainy season in Northeastern Ecuador is at its peak between March and July. I conducted my study between the months of June and August, 2024. The average high temperature for June in this region is 85.66° F, with the average low of 70.05° F. July has an average high temperature of 86.29° F and an average low of 69.13° F. August has an average high temperature of 91.35° F and an average low of 69.60° F. June receives 143mm of precipitation on average each year, whereas July receives 99.69mm and August receives 77.55mm. (https://weatherandclimate.com/ecuador/orellana/boca-tiputini) 
Put project description here (field sites, time frame of collection,sampling scheme, type of data (eg. species ID,temp, etc.) )

Surveys: Herpetofauna were sampled using visual surveys on foot by two surveyors/night. Trail systems at each site served as the sampling paths. The surveys were repeated around 6 times on each rotation while in the field, and resampled on the second rotations. The surveys typically began around 20:00-20:30 and lasted until 23:00-00:00 CST. At each site, habitat matches were compared and assessed and trails through that habitat were consistently walked. Two different types of habitat, Terra Firma (uplands) and Varzea (flooded forest) were surveyed on the herp nocturnal walks. In addition to this, two significant bodies of water were also surveyed at each site, primarily consisting of oxbow lakes with one year-round large pond. 

	Surveyors used FENIX HM60R headlamps while conducting night surveys. They carefully examined all surrounding habitat, including understory trees, shrubs, vines, water bodies, forest floor, and middle-canopy. Amphibians of the order Anura gave off reflective eyeshine and were easier to sample for, whereas members of Squamata did not. More information about this will be within the discussion section. Effort hours will be calculated based on survey time length and number of surveyors. 

	Additionally, environmental information was taken throughout the course of each survey. Temperature and humidity data was collected with a Mengshen meter in 30 minute intervals on surveys. Understory vegetation density was also measured every 15 minutes along each trail. A 1.5m PVC pipe was randomly placed upright just off the right side of the trail at each measuring point, and the number of leaves making contact with the pipe was counted. 

	Weather and wind were noted before each survey in four nominal categories, with weather either being “clear, partly cloudy, cloudy, rainy” and wind being “no wind, felt on face, branches move, trees move”. I also accounted for precipitation that had already occurred in 6-hour blocks as “time window of last rain event”. 

	Once an animal was found, the first step of the protocol was to note what time of night the find occurred. After this, the temperature and humidity was once again collected. A rangefinder was used to estimate the perpendicular distance of each animal from the trail. A GPS was used to mark and log the coordinates of each animal found. Animals were given a two-letter code based on the Order and Suborder followed by a number, indicating its position of being found. For example, the code of the 9th snake found of the season would be SK09. Species found were also identified to the lowest taxonomic level in the field, and photographs of individuals were taken both to get positive IDs later in the lab when not possible in the field, but also to avoid counting re-captures.

	Snakes found during non-survey times were also recorded. These individuals were split into one of two categories of detection. The first is an “Opportunistic Encounter” (OE), which is any snake that was found by me while out working on other non-herpetofauna projects in the field. The other type of detection is the Third Party Encounter (TPE). This was any snake that was found by other research groups during my rotations at each station, identified to lowest possible taxonomy. The same data was taken for these individuals. GPS coordinates, time of detection, trail, observer, estimation of distance from trail, and habitat type. Because the third-party observers often didn’t have access to the climate data logger, this information was retrieved later on from each station’s respective weather tower data, based on the time of detection. 

Snakes were given a classification as to whether they were small mammal consumers or not. Information on this was retrieved from literature such as online publications, the book Reptiles and Amphibians of the Amazon by R.D. and Patricia Bartlett, and the expert webpage Reptiles of Ecuador. 

# Analysis

## Prep data

Data preparation summary:

1. Join snake data collected during standard surveys with the opportunistic/third person data

2. [...add here when we work in other dataframes...]

```{r data read in and do prelim cleaning}

snake.sur <- read.csv("UPDATEDsnake.survey.csv", na.strings = c("", "NA")) #reading in csv file

df.snake.non.sur <- read.csv("snake.non_survey.csv") 

snake.sur<- snake.sur[-c(2, 57:70),] #removing row 2, 57-70
colnames(snake.sur) <- snake.sur[1, ] #takes 1st row and makes it column names
snake.sur <- snake.sur[-1, ] #removed extra row that originally had column names but were now useless
snake.sur <- snake.sur[ ,-23] #removing column 23


colnames(df.snake.non.sur) <- df.snake.non.sur[1, ] #swt column names up for third party and opportunistic dataframe
df.snake.non.sur <- df.snake.non.sur[-1, ] #removing first row since it is the same as column names now

# we will now compare column names

#colnames(df.snake.sur)
#colnames(df.snake.non.sur)


snake.sur$Species <- str_replace_all(snake.sur$Species, " ", "_") #replaces all spaces w/ underscore

# also get rid of asterisks in dates
snake.sur$Date <- gsub("\\*", "", snake.sur$Date)

# tell R that the Date column are Dates

snake.sur$Date <- as.Date(snake.sur$Date, format = "%m/%d/%y")

snake.sur$End_Date <- as.Date(snake.sur$End_Date, format = "%m/%d/%y")

df.snake.non.sur$Date <- as.Date(df.snake.non.sur$Date, format = "%m/%d/%y")

df.snake.non.sur$End_Date <- as.Date(df.snake.non.sur$Date, format = "%m/%d/%y")

df.snake.non.sur <- df.snake.non.sur[, -21]

snake.sur$Obs_type <- "Survey"
colnames(df.snake.non.sur)[4] <- "Obs_type"

colnames(snake.sur)[7] <- "Snake_ID" #changing reptile Id to snake ID

colnames(snake.sur)[10] <- "Time_Found"

colnames(snake.sur)[3] <- "Location"
colnames(df.snake.non.sur)[3] <- "Location" 

df.snake.non.sur$Survey_Start_Time <- NA
df.snake.non.sur$Surveyors <- NA
df.snake.non.sur$Survey_End_Time <- NA

colnames(snake.sur)[15] <- "Distance_m"
colnames(df.snake.non.sur)[6] <- "During_My_Rotation"

df.snake.non.sur$Distance_m <- NA


snake.sur$During_My_Rotation <- "Yes"

snake.master <- rbind(df.snake.non.sur, snake.sur)
```

Begin looking at variation in sampling effort. First, calculate time spend sampling during each night for surveys.

```{r survey samp effort}

# this is only relevant to the snake surveys, to get n hours spent searching

# first, combine date and time so that you can use 'difftime' to get time elapsed between start and end

snake.sur$Date_Start_Time <- paste(snake.sur$Date, snake.sur$Survey_Start_Time, sep = " ")

#combining end date and time into one column for the full snake dataframe, separated with spaces
# note, R is handeling surveys that lasted past midnight oddly, so we are just using the start Date here as well
snake.sur$Date_End_Time <- paste(snake.sur$Date, snake.sur$Survey_End_Time, sep = " ")

# using difftime to calculate effort hours on each survey
snake.sur$Effort_Hrs <- difftime(snake.sur$Date_End_Time, snake.sur$Date_Start_Time, units = "hours")

```

Now, we want to summarize how many snakes were seen per hour. This is going to involve (1) calculating abundance per survey and then (2) getting a rate of n snakes per hour.

```{r abundance over search effort}

# use dplyr (tidyverse) functions to aggregate the data

temp <- snake.sur %>%
  group_by(Station, Location, Date, Species, Effort_Hrs) %>%
  tally()

# make an extra column that has the station ID and trail walked and date, separated by //

temp$st.tr.date <- paste(temp$Station, temp$Location, temp$Date, temp$Effort_Hrs, sep = "//")

# now, let's use dplyr again to transpose (flip) your sp.abun dataframe so that now, you have the species as column names and the number of times they were found at each trail and date will be the data reported (expect lots of 0s and 1s)

snake.mat <- temp %>% 
  pivot_wider(names_from = Species, 
              values_from = n, 
              values_fill = 0) %>%
  column_to_rownames(var = "st.tr.date")

# cool, now, we need to pull the info out of the row names and make that info columns again. Note, there is probably a better way to do this but here we are. 

snake.mat$st.tr.date <- rownames(snake.mat)

# now you have a column with that whole mess of info
# let's separate the info back out into 3 separate columns
snake.mat <- snake.mat %>% 
  separate(st.tr.date, c('Station', 'Location', 'Date', 'Effort_Hrs'), sep = "//")

# remove column of NA data which was made when we incorporated the surveys during which no snakes were found

snake.mat <- snake.mat %>%
  select(-"NA")

# great, let's start getting some info together regarding the abundance, diversity, and species richness of snakes found for each night we did a survey

# get abundance next
snake.mat$total_found <- rowSums(snake.mat[1:16])

# for diversity, we know Simpson's is robust to unbalanced sampling; may change to only using Simpsons. Use function 'diversity' in vegan package, specify the index you want to use (simpson)
snake.mat$simpson_diversity <- diversity(snake.mat[1:16], index = "simpson")

# remove temp df
rm(temp)

# and lets get species richness
snake.mat$richness <- specnumber(snake.mat[1:16])

# at this point, you will want to do a sanity check. Do the data look believable based on what you remember of your time in the field?

# now, get a rate of n snakes obs per hours of searching
snake.mat$total.hr <- (snake.mat$total_found/as.numeric(snake.mat$Effort_Hrs))

# repeat this for richness and diversity
snake.mat$richness.hr <- (snake.mat$richness/as.numeric(snake.mat$Effort_Hrs))

snake.mat$diversity.hr <- (snake.mat$simpson_diversity/as.numeric(snake.mat$Effort_Hrs))

# start building a df for plotting

snake.plot.df <- as.data.frame(snake.mat[17:26])

```

Now, what about if we look at the snakes split up into their different diet types?

```{r break up by guild}
# group by Station, Location, Date, Diet_Type and count n occurences to get n snakes per diet type per survey
temp <- snake.sur %>%
  group_by(Station, Location, Date, Diet_Type) %>%
  tally()

# make a unique row names identifier
temp$st.tr.date <- paste(temp$Station, temp$Location, temp$Date, sep = "//")

# do this to get the zeros where we need them
guild.mat <- temp %>% 
  pivot_wider(names_from = Diet_Type, 
              values_from = n, 
              values_fill = 0) %>%
  column_to_rownames(var = "st.tr.date")

# cool, now, we need to pull the info out of the row names and make that info columns again. Note, there is probably a better way to do this but here we are. 

guild.mat$st.tr.date <- rownames(guild.mat)

# now you have a column with that whole mess of info
# let's separate the info back out into 3 separate columns
guild.mat <- guild.mat %>% 
  separate(st.tr.date, c('Station', 'Location', 'Date'), sep = "//")

# remove column of NA data which was made when we incorporated the surveys during which no snakes were found
guild.mat <- guild.mat %>%
  select(-"NA")

# dont' need the temp df anymore
rm(temp)

# this is annoying but now reformat it so have columns for Diet_Type, etc
guild.mat <- guild.mat %>% 
  pivot_longer(cols = c("no mammals", "mostly mammals", "mixed"),
    names_to = "Diet_Type",
    values_to = "n_per_guild")

# add this to the plotting df

snake.plot.df <- left_join(guild.mat, snake.plot.df, by = c("Location", "Date", "Station"))
```

## Visualize + explore data

Let's make some boxplots.

```{r prelim snake abundance plots}

# use ggplot to make some boxplots

snake.plot.df %>%
  filter(total_found != 0) %>%
  ggplot(aes(x = Station, y = total_found, fill = Station)) +
    geom_boxplot() + theme_bw() + theme(legend.position = "none", axis.title.x = element_blank()) + scale_fill_manual(values=c("darkseagreen3", "deeppink3")) + scale_x_discrete(labels = c("Unhunted forest (TBS)", "Hunted forest (YRS)")) +
ylab("Total snakes") + ggtitle("Total snakes found per survey night")

#####

snake.plot.df %>%
  filter(total.hr != 0) %>%
  ggplot(aes(x = Station, y = total.hr, fill = Station)) +
    geom_boxplot() + theme_bw() + theme(legend.position = "none", axis.title.x = element_blank()) + scale_fill_manual(values=c("darkseagreen3", "deeppink3")) + scale_x_discrete(labels = c("Unhunted forest (TBS)", "Hunted forest (YRS)")) +
ylab("# snakes found\nper hour") + ggtitle("Snakes found per hour searching")

####

snake.plot.df %>%
  filter(richness.hr != 0) %>%
  ggplot(aes(x = Station, y = richness.hr, fill = Station)) +
    geom_boxplot() + theme_bw() + theme(legend.position = "none", axis.title.x = element_blank()) + scale_fill_manual(values=c("darkseagreen3", "deeppink3")) + scale_x_discrete(labels = c("Unhunted forest (TBS)", "Hunted forest (YRS)")) +
ylab("Total snake species found\nper hour") + ggtitle("N species found per hour searching")

###

snake.plot.df %>%
  filter(simpson_diversity !=0) %>%
  ggplot(aes(x = Station, y = simpson_diversity, fill = Station)) +
    geom_boxplot() + theme_bw() + theme(legend.position = "none", axis.title.x = element_blank()) + scale_fill_manual(values=c("darkseagreen3", "deeppink3")) + scale_x_discrete(labels = c("Unhunted forest (TBS)", "Hunted forest (YRS)")) +
ylab("Simpson diversity") + ggtitle("Snake diversity")

####

snake.plot.df %>%
  ggplot(aes(x = Diet_Type, y = n_per_guild, fill = Station)) +
    geom_boxplot() + theme_bw() + scale_fill_manual(values=c("darkseagreen3", "deeppink3", "burlywood3")) + ylab("N snakes") + ggtitle("Diet types")

```

Okay cool good start. Want to make a little more informative plots with standard errors now. 

```{r get summary species richness data and plot it}

richness.hr.summ <- snake.plot.df %>%
  group_by(Station) %>%
  summarise(mean_richness.hr = mean(richness.hr),
            sdrichness.hr = sd(richness.hr),
            nrichness.hr = n()) %>%
  mutate(SErichness.hr = sdrichness.hr / sqrt(nrichness.hr),
         lower.ci.richness.hr = mean_richness.hr - qt(1 - (0.05 / 2), nrichness.hr - 1) * SErichness.hr,
         upper.ci.richness.hr = mean_richness.hr + qt(1 - (0.05 / 2), nrichness.hr - 1) * SErichness.hr,
         lower.se.richness.hr = mean_richness.hr - SErichness.hr,
         upper.se.richness.hr = mean_richness.hr + SErichness.hr)


###

# plot 
richness.hr.summ.plot <- richness.hr.summ %>%  
  ggplot(aes(x= Station, y= mean_richness.hr, color = Station, shape = Station)) +
  scale_colour_manual(values = c("seagreen4", "deeppink4")) +
  geom_linerange(aes(ymin = lower.se.richness.hr, ymax = upper.se.richness.hr), linewidth = 0.15, color = "black") +
  geom_point(size = 3) + 
  ylab("N species found per hour") +
  xlab(NULL) +
  ggtitle("Snake species richness") +
  theme_light() +
  theme(axis.title.y = element_text(colour = "black")) +
  theme(axis.title.x = element_text(colour = "black")) +
  theme(axis.text = element_text(colour = "black")) +
  theme(strip.text.x = element_text(colour = "black")) + 
  theme(legend.position = "none")

richness.hr.summ.plot

#ggsave(plot = richness.hr.summ.plot, "snake_richness.jpg", width = 4, height = 4)

# clean env
rm(richness.hr.summ.plot)
```



```{r get summary species abundance data and plot it}

abund.hr.summ <- snake.plot.df %>%
  group_by(Station) %>%
  summarise(mean_abund.hr = mean(total.hr),
            SD.abund.hr = sd(total.hr),
            N.abund.hr = n()) %>%
  mutate(SE.abund.hr = SD.abund.hr / sqrt(N.abund.hr),
         lower.ci.abund.hr = mean_abund.hr - qt(1 - (0.05 / 2), N.abund.hr - 1) * SE.abund.hr,
         upper.ci.abund.hr = mean_abund.hr + qt(1 - (0.05 / 2), N.abund.hr - 1) * SE.abund.hr,
         lower.se.abund.hr = mean_abund.hr - SE.abund.hr,
         upper.se.abund.hr = mean_abund.hr + SE.abund.hr)

###

# plot 
abund.hr.summ.plot <- abund.hr.summ %>%  
  ggplot(aes(x= Station, y= mean_abund.hr, color = Station, shape = Station)) +
  scale_colour_manual(values = c("seagreen4", "deeppink4")) +
  geom_linerange(aes(ymin = lower.se.abund.hr, ymax = upper.se.abund.hr), linewidth = 0.15, color = "black") +
  geom_point(size = 3) + 
  ylab("Total snakes found per hour") +
  xlab(NULL) +
  ggtitle("Snake abundances") +
  theme_light() +
  theme(axis.title.y = element_text(colour = "black")) +
  theme(axis.title.x = element_text(colour = "black")) +
  theme(axis.text = element_text(colour = "black")) +
  theme(strip.text.x = element_text(colour = "black")) + 
  theme(legend.position = "none")

abund.hr.summ.plot

#ggsave(plot = abund.hr.summ.plot, file = "snake_abundance.jpg", height = 4, width = 4)

# clean env
rm(abund.hr.summ.plot)
```


```{r get summary species diversity data and plot it}

diversity.hr.summ <- snake.plot.df %>%
  group_by(Station) %>%
  summarise(mean_diversity.hr = mean(diversity.hr),
            sddiversity.hr = sd(diversity.hr),
            ndiversity.hr = n()) %>%
  mutate(SEdiversity.hr = sddiversity.hr / sqrt(ndiversity.hr),
         lower.ci.diversity.hr = mean_diversity.hr - qt(1 - (0.05 / 2), ndiversity.hr - 1) * SEdiversity.hr,
         upper.ci.diversity.hr = mean_diversity.hr + qt(1 - (0.05 / 2), ndiversity.hr - 1) * SEdiversity.hr,
         lower.se.diversity.hr = mean_diversity.hr - SEdiversity.hr,
         upper.se.diversity.hr = mean_diversity.hr + SEdiversity.hr)


###

# plot 
diversity.hr.summ.plot <- diversity.hr.summ %>%  
  ggplot(aes(x= Station, y= mean_diversity.hr, color = Station, shape = Station)) +
  scale_colour_manual(values = c("seagreen4", "deeppink4")) +
  geom_linerange(aes(ymin = lower.se.diversity.hr, ymax = upper.se.diversity.hr), linewidth = 0.15, color = "black") +
  geom_point(size = 3) + 
  ylab("Diversity (Simpson's) per hour") +
  xlab(NULL) +
  ggtitle("Snake species diversity") +
  theme_light() +
  theme(axis.title.y = element_text(colour = "black")) +
  theme(axis.title.x = element_text(colour = "black")) +
  theme(axis.text = element_text(colour = "black")) +
  theme(strip.text.x = element_text(colour = "black")) + 
  theme(legend.position = "none")

diversity.hr.summ.plot

#ggsave(plot = diversity.hr.summ.plot, file = "snake_diversity.jpg", height = 4, width = 4)

# clean env
rm(diversity.hr.summ.plot)

```


```{r get summary diet type data and plot it}

guild.summ <- snake.plot.df %>%
  group_by(Station, Diet_Type) %>%
  summarise(mean_perguild = mean(n_per_guild),
            SDperguild = sd(n_per_guild),
            Nperguild = n()) %>%
  mutate(SEperguild = SDperguild / sqrt(Nperguild),
         lower.ci.richness.hr = mean_perguild - qt(1 - (0.05 / 2), Nperguild - 1) * SEperguild,
         upper.ci.perguild = mean_perguild + qt(1 - (0.05 / 2), Nperguild - 1) * SEperguild,
         lower.se.perguild = mean_perguild - SEperguild,
         upper.se.perguild = mean_perguild + SEperguild)
###

# plot 
guild.summ.plot <- guild.summ %>%  
  
  ggplot(aes(x= Diet_Type, y= mean_perguild, shape = Station, group = Station, color = Station)) +
  geom_pointrange(aes(ymin = lower.se.perguild, 
                     ymax = upper.se.perguild), position = position_dodge(width = 0.3), size = 1) +
  scale_color_manual(values = c("seagreen4", "deeppink4")) +
  ylab("N snakes per guild") +
  xlab(NULL) +
  ggtitle("Snake abundance per diet type") +
  theme_light() +
  theme(axis.title.y = element_text(colour = "black")) +
  theme(axis.title.x = element_text(colour = "black")) +
  theme(axis.text = element_text(colour = "black")) +
  theme(strip.text.x = element_text(colour = "black"))

guild.summ.plot

# save figures (quick and dirty)
#ggsave(plot = guild.summ.plot, file = "snakes_per_guild.jpg", height = 4, width = 4)

```

```{r sample size overview}

# n surveys per station
snake.sur %>%
  group_by(Station) %>%
  summarize(n = n_distinct(Date))

# 14 (if counting pilot) surveys at TBS
# 12 at YRS

# different routes

snake.sur %>%
  group_by(Station) %>%
  summarize(n = n_distinct(Location))

#9 distinct routes at TBS (with pilot)
#6 at YRS

# cumulative time spent searching
snake.mat %>%
  group_by(Station) %>%
  summarize(hours = sum(as.numeric(Effort_Hrs)))

# 42 hours vs 34 hours

# n species found at each

snake.sur %>%
  group_by(Station) %>%
  summarize(n_species = n_distinct(na.omit(Species)))
# 13 at TBS, 10 at YRS

# n snakes found at each
snake.mat %>%
  group_by(Station) %>%
  summarize(n_found = sum(total_found))

# standardize by hours

snake.mat %>%
  group_by(Station) %>%
  summarize(n_found.per.hr = (sum(total_found))/(sum(as.numeric(Effort_Hrs))))


```

## Community dissimilarity

```{r pull out predictors and community data for analysis}

predictors <- sp.abun.mat[, c(18:21)] # separate out predictor variables to use in the adonis permanova function

visitors<- sp.abun.mat[, c(1:17)] # only want columns with species abundances for the vegdist functions

```

# First, use vegdist (vegan) to compute community dissimilarity matrix based on the Jaccard index
```{r jaccard}

Jaccard.dis.mat <- vegdist(visitors, method = "jaccard")
# Analyze dissimilarity data to test for differences in communities found at diff stations use adonis2 function to perform a PERMANOVA (permutational multivariate ANOVA, a non-parametric alternative to MANOVA, or multivariate ANOVA test).

# First, simple model

pmnv.jac1 <- adonis2(Jaccard.dis.mat ~ predictors$Station, method = "jaccard") 

print(pmnv.jac1)

# Yes, communities between plant species are significantly different, as expected.

# Visually, what's going on?
# Nonmentric multidimensional scaling of community dissimilarity values based on the Jaccard index
nmds.jac1 <- metaMDS(visitors, distance = "jaccard", autotransform = FALSE, maxtry = 200, k = 2) 

stressplot(nmds.jac1)
#goodness(nmds.jac1)
```

```{r H-M index plus adonis plus nmds, warning = FALSE}

horn.dis.mat <- vegdist(visitors, method = "horn")

# First, simple model, do the communities differ between plant species?

pmnv.horn1 <- adonis2(horn.dis.mat ~ predictors$Station, method = "horn") 

print(pmnv.horn1)

```






















